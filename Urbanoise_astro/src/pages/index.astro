---
import { cacheFeaturedImage, getWpAuthHeader } from "../lib/wp.js";

const wpHeaders = getWpAuthHeader();

const postsEndpoint =
  "https://urbanoise.com/wpheadless/wp-json/wp/v2/posts?per_page=3&_embed";
let fetchedPosts = [];
try {
  const response = await fetch(postsEndpoint, { headers: wpHeaders });
  if (response.ok) {
    const posts = await response.json();
    if (Array.isArray(posts)) {
      fetchedPosts = posts;
    }
  }
} catch (error) {
  console.error("Unable to fetch WordPress posts:", error);
}

const stripHtml = (value) => (value ? value.replace(/<[^>]+>/g, "").trim() : "");
const clampText = (value, max = 70) =>
  value && value.length > max ? `${value.slice(0, max).trimEnd()}...` : value;

let normalizedPosts = [];
if (fetchedPosts.length) {
  normalizedPosts = await Promise.all(
    fetchedPosts.map(async (post) => {
      const rawTitle = post.title?.rendered ?? "Untitled";
      const rawExcerpt = post.excerpt?.rendered ?? "";
      const title = stripHtml(rawTitle) || "Untitled";
      const excerptSource =
        stripHtml(rawExcerpt) ||
        (stripHtml(post.content?.rendered)?.slice(0, 140) || "Short summary coming soon.");
      const excerpt = clampText(excerptSource, 70);
      const slug = post.slug;
      const id = post.id;
      const link = slug ? `/blog/${slug}` : post.link ?? "#";
      const embedded = post._embedded?.["wp:featuredmedia"];
      const featured = Array.isArray(embedded) ? embedded[0] : null;
      const featuredUrl = featured?.source_url ?? "";
      const featuredAlt = featured?.alt_text ?? title;
      const localFeaturedUrl = await cacheFeaturedImage(featuredUrl, id, wpHeaders);
      const image = localFeaturedUrl || "";
      const content = post.content?.rendered ?? "";
      const date = post.date ?? "";
      const terms = post._embedded?.["wp:term"];
      const categories = Array.isArray(terms) && Array.isArray(terms[0])
        ? terms[0].map((term) => term?.name).filter(Boolean)
        : [];
      const categoryName = categories[0] ?? "Blog";
      return {
        title,
        excerpt,
        link,
        image,
        categoryName,
        slug,
        id,
        content,
        featuredUrl: localFeaturedUrl || "",
        featuredAlt,
        categories,
        date,
      };
    })
  );
}

const fallbackArticles = [
  {
    title: "Frame the Moment",
    excerpt:
      "A short note on how we compose lighting tests and time the camera for the perfect architectural still.",
    link: "#about",
    image: "Photos/work1.jpg",
    categoryName: "Photoplay",
  },
  {
    title: "Architectural Notes",
    excerpt:
      "Sketches, sound cues, and the feeling of materiality that eventually become the visual narrative.",
    link: "#mockup",
    image: "Photos/work2.jpg",
    categoryName: "Notes",
  },
  {
    title: "City in Motion",
    excerpt:
      "Documenting the structural rhythm of the places we inhabit — slow pans, wide lenses, honest light.",
    link: "#contact",
    image: "Photos/work3.jpg",
    categoryName: "Journal",
  },
  {
    title: "Studio Dispatch",
    excerpt:
      "Updates from the Urbanoise studio and the experiments that lead into every new film and photograph.",
    link: "#stage",
    image: "Photos/us2.JPG",
    categoryName: "Studio",
  },
];

const articles = (normalizedPosts.length ? normalizedPosts : fallbackArticles).slice(0, 3);
const articleOverlayData = normalizedPosts.map((post) => ({
  id: post.id,
  slug: post.slug,
  title: post.title,
  content: post.content,
  featuredUrl: post.featuredUrl,
  featuredAlt: post.featuredAlt,
  categories: post.categories,
  date: post.date,
}));
const articlePayload = JSON.stringify(articleOverlayData).replace(/</g, "\\u003c");

const siteUrl = "https://urbanoise.com";
const pageTitle = "Urbanoise — Architectural Films";
const pageDescription =
  "Urbanoise is a film and photography studio focused on architectural documentaries, spatial storytelling, and cinematic visuals.";
const canonicalUrl = new URL("/", siteUrl).href;
const ogImage = `${siteUrl}/Opengraph.jpg`;
const structuredData = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "Organization",
      name: "Urbanoise",
      url: siteUrl,
      logo: `${siteUrl}/favicon.ico`,
      sameAs: ["https://www.instagram.com", "https://www.linkedin.com"],
    },
    {
      "@type": "WebSite",
      name: "Urbanoise",
      url: siteUrl,
      description: pageDescription,
      publisher: {
        "@type": "Organization",
        name: "Urbanoise",
        url: siteUrl,
      },
    },
  ],
};
---
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{pageTitle}</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="canonical" href={canonicalUrl} />
    <meta name="description" content={pageDescription} />
    <meta name="robots" content="index, follow" />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:site_name" content="Urbanoise" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={pageDescription} />
    <meta name="twitter:image" content={ogImage} />
    <script type="application/ld+json" set:html={JSON.stringify(structuredData)}></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://api.fontshare.com/v2/css?f[]=cabinet-grotesk@800&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://api.fontshare.com/v2/css?f[]=satoshi@400,500,700&f[]=tanker@400&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./styles.css" />
    <link rel="stylesheet" href="./styles-phone.css" media="(max-width: 480px)" />
    <link
      rel="stylesheet"
      href="./styles-phone-lg.css"
      media="(min-width: 481px) and (max-width: 768px)"
    />
    <link
      rel="stylesheet"
      href="./styles-tablet.css"
      media="(min-width: 769px) and (max-width: 1024px)"
    />
    <link
      rel="stylesheet"
      href="./styles-laptop.css"
      media="(min-width: 1025px) and (max-width: 1440px)"
    />
    <link
      rel="stylesheet"
      href="./styles-13inch.css"
      media="(width: 1440px) and (min-height: 699px) and (max-height: 730px)"
    />
    <link
      rel="stylesheet"
      href="./styles-desktop.css"
      media="(min-width: 1441px) and (max-width: 1920px)"
    />
    <link rel="stylesheet" href="./styles-4k.css" media="(min-width: 1921px)" />
  </head>
  <body>
    <header class="site-header" aria-label="Primary">
      <div class="site-brand">Urbanoise</div>
      <nav class="nav-links">
        <a class="nav-link" href="mailto:info@urbanoise.com">Start a project</a>
        <a class="nav-link" href="#about">About us</a>
      </nav>
    </header>
    <main>
      <section class="stage" id="stage" aria-label="Urbanoise landing">
        <div class="video-frame" aria-label="Urbanoise featured video">
          <video
            class="hero-video"
            src="https://sufianararah.com/wp-content/uploads/2025/03/website_1.mp4"
            autoplay
            muted
            loop
            playsinline
          ></video>
          <div class="video-fallback" aria-hidden="true"></div>
          <button class="scroll-bumper" type="button" aria-label="Scroll down to About us">
            Scroll down
          </button>
        </div>

        <div class="stage-overlay">
          <h1 class="logo logo-button" role="button" tabindex="0" aria-label="Enter Urbanoise">
            <span class="sr-only">Urbanoise</span>
            <span class="logo-wrap logo--stack" aria-hidden="true">
              <span class="logo-letter logo-letter-urb">U</span>
              <span class="logo-letter logo-letter-urb">R</span>
              <span class="logo-letter logo-letter-urb">B</span>
              <span class="logo-letter logo-letter-ano">A</span>
              <span class="logo-letter logo-letter-ano">N</span>
              <span class="logo-letter logo-letter-ano">O</span>
              <span class="logo-letter logo-letter-ise">I</span>
              <span class="logo-letter logo-letter-ise">S</span>
              <span class="logo-letter logo-letter-ise">E</span>
            </span>
          </h1>

          <button class="enter-cta" type="button" aria-label="Click to enter">
            <span class="cursor-icon" aria-hidden="true">
              <svg viewBox="0 0 48 48" fill="none">
                <path
                  d="M12 6l26 24-11 1.5 5.2 10.8-4.2 1.9-5.2-10.8-8.6 7.1L12 6Z"
                  fill="currentColor"
                />
              </svg>
            </span>
            <span class="cta-text">Click to enter</span>
          </button>
        </div>
      </section>

      <section class="about-page" id="about" aria-label="About Urbanoise">
        <div class="about-grid">
          <div class="about-viewport">
            <div class="about-slide-track"></div>
          </div>
          <div class="about-actions">
            <div class="about-phone-controls" role="group" aria-label="About variants navigation">
              <button type="button" class="about-phone-nav about-phone-prev" aria-label="Previous variant">‹</button>
              <span class="about-phone-label" aria-live="polite"></span>
              <button type="button" class="about-phone-nav about-phone-next" aria-label="Next variant">›</button>
            </div>
            <div class="about-controls" role="group" aria-label="About variants">
              <button
                type="button"
                class="about-variant-button is-active"
                data-variant="films"
                aria-pressed="true"
              >
                FILMS
              </button>
              <button type="button" class="about-variant-button" data-variant="photography" aria-pressed="false">
                Photography
              </button>
              <button type="button" class="about-variant-button" data-variant="consultations" aria-pressed="false">
                Consultations
              </button>
              <button type="button" class="about-variant-button" data-variant="about" aria-pressed="false">
                About us
              </button>
            </div>
          </div>
        </div>
      </section>

      <section class="mockup-page" id="mockup" aria-label="Mockup showcase">
        <div class="mockup-inner articles-inner">
          <div class="articles-heading">
            <p>Work in focus</p>
            <h2>Articles</h2>
          </div>
          <div class="articles-grid">
            {articles.map((article) => (
              <article class="article-card">
                <a
                  class="article-thumb-link"
                  href={article.link}
                  data-post-id={article.id}
                  data-post-slug={article.slug}
                  aria-label={`Open article: ${article.title || "Untitled"}`}
                >
                  {article.image ? (
                    <figure class="article-thumb">
                      <img src={article.image} alt={`Thumbnail for ${article.title}`} loading="lazy" />
                    </figure>
                  ) : null}
                </a>
                <div class="article-card-body">
                  <p class="article-label">{article.categoryName ?? "Blog"}</p>
                  <h3>{article.title || "Untitled"}</h3>
                  <p class="article-card-excerpt">
                    {clampText(article.excerpt || "Short summary coming soon.", 70)}
                  </p>
                </div>
              </article>
            ))}
          </div>
        </div>
      </section>

      <section class="footer-page" id="contact" aria-label="Get in touch">
        <div class="footer-inner">
          <div class="footer-newsletter">
            <p class="footer-lead">
              Sign up to receive updates on new work, behind-the-scenes notes, and screenings.
            </p>
            <form
              class="footer-newsletter-form"
              method="POST"
              action="https://d662e9e1.sibforms.com/serve/MUIFALaUJNiZduD2dWCUsUfuBClVksUauK1s3hNzI5niw4gMi_T2x4Xg5mNT5j0y1zKu6YIg94oAIPzy9pL3-uQMD3Vk0cz5TT_11GOsyoWvXN5eb1oli-pCM9eQXfRm93uhBy82UJ9q2RCF_FqGIIdeZpXUo_sCFavLq_oz7tJanmjQ_jxupGAIvdJCra8XmafQJXsr6MGnfHgyAw=="
              target="brevo-target"
            >
              <label class="sr-only" for="newsletter-email">Email address</label>
              <div class="footer-newsletter-field">
                <input
                  id="newsletter-email"
                  name="EMAIL"
                  type="email"
                  placeholder="Email address"
                  required
                  autocomplete="email"
                />
                <button type="submit">Subscribe</button>
              </div>
              <input type="text" name="email_address_check" value="" class="input--hidden" tabindex="-1" autocomplete="off" />
              <input type="hidden" name="locale" value="en" />
              <input type="hidden" name="html_type" value="simple" />
            </form>
            <iframe name="brevo-target" class="brevo-iframe" title="Brevo submission target"></iframe>
            <p class="footer-newsletter-status" role="status" aria-live="polite"></p>
          </div>
          <div class="footer-meta">
            <div class="footer-social" aria-label="Urbanoise social links">
              <a class="footer-social-link" href="https://www.instagram.com" target="_blank" rel="noreferrer noopener" aria-label="Instagram">
                <svg viewBox="0 0 24 24" role="img">
                  <path d="M17 2H7C4.2 2 2 4.2 2 7v10c0 2.8 2.2 5 5 5h10c2.8 0 5-2.2 5-5V7c0-2.8-2.2-5-5-5zm3 15c0 1.7-1.3 3-3 3H7c-1.7 0-3-1.3-3-3V7c0-1.7 1.3-3 3-3h10c1.7 0 3 1.3 3 3v10z" />
                  <path d="M12 7.3A4.7 4.7 0 1 0 16.7 12 4.7 4.7 0 0 0 12 7.3zm0 7.6A2.9 2.9 0 1 1 14.9 12 2.9 2.9 0 0 1 12 14.9zM17.9 6.4a1.1 1.1 0 1 1-1.1-1.1 1.1 1.1 0 0 1 1.1 1.1z" />
                </svg>
              </a>
              <a class="footer-social-link" href="https://www.linkedin.com" target="_blank" rel="noreferrer noopener" aria-label="LinkedIn">
                <svg viewBox="0 0 24 24" role="img">
                  <path d="M4.5 9h3v12h-3zM6 4.5a1.75 1.75 0 1 1-1.75 1.75A1.75 1.75 0 0 1 6 4.5zM9 9h2.8v1.7h.1a3.08 3.08 0 0 1 2.8-1.6c3 0 3.5 2 3.5 4.6V21h-3v-5.1c0-1.3 0-3-1.8-3s-2 1.4-2 2.9V21H9z" />
                </svg>
              </a>
            </div>
            <a class="footer-back" href="#stage">Back to main page</a>
            <p class="footer-note">Urbanoise © 2025 Imprint</p>
          </div>
        </div>
      </section>
    </main>
    <div class="article-overlay" aria-hidden="true" hidden>
      <div class="article-frame" role="dialog" aria-modal="true" aria-label="Article">
        <div class="article-frame-header">
          <button class="article-close" type="button" aria-label="Close article">Close</button>
        </div>
        <div class="article-frame-body">
          <p class="article-loading" hidden>Loading article...</p>
          <div class="article-content"></div>
        </div>
      </div>
    </div>

    <style>
      .mockup-page {
        background: #0b0b0b;
      }
      .mockup-inner.articles-inner {
        --articles-gap: clamp(0.7rem, 1.3vw, 1.2rem);
        padding: clamp(3rem, 5vw, 4.5rem) var(--articles-gap);
      }
      .articles-inner {
        max-width: none;
        width: 100%;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1fr;
        gap: clamp(2rem, 3vw, 2.5rem);
      }
      .articles-heading {
        grid-column: 1 / -1;
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.4em;
        margin-bottom: 0;
      }
      .articles-heading h2 {
        margin: 0.8rem 0 0.2rem;
        font-size: clamp(2.5rem, 3vw, 3.5rem);
        line-height: 1.2;
        letter-spacing: 0.02em;
        font-family: var(--font-head);
      }
      .articles-heading p {
        margin: 0;
        max-width: 36ch;
        font-size: 1rem;
        line-height: 1.5;
      }
      .articles-grid {
        grid-column: 1 / -1;
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: var(--articles-gap);
        width: 100%;
      }
      .article-card {
        background: #0b0b0b;
        border-radius: 20px;
        overflow: visible;
        box-shadow: 0 30px 50px rgba(0, 0, 0, 0.45);
        transition: transform 0.3s ease;
        display: flex;
        flex-direction: column;
        aspect-ratio: auto;
        position: relative;
        border: 0;
        padding: clamp(0.45rem, 0.8vw, 0.65rem);
      }
      .article-card:hover {
        transform: translateY(-10px);
      }
      .article-thumb {
        aspect-ratio: 16 / 9;
        height: auto;
        width: 100%;
        overflow: hidden;
        margin: 0;
        border-radius: 14px;
      }
      .article-thumb-link {
        display: block;
        width: 100%;
      }
      .article-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: center 20%;
        display: block;
      }
      .article-card-body {
        padding: clamp(0.65rem, 1vw, 0.9rem) clamp(0.2rem, 0.5vw, 0.35rem) 0;
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        justify-content: flex-start;
        color: #f3f3f3;
      }
      .article-label {
        font-size: 0.58rem;
        letter-spacing: 0.4em;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.6);
        margin: 0;
        font-weight: 600;
      }
      .article-card h3 {
        margin: 0;
        font-size: clamp(0.88rem, 1.25vw, 1.05rem);
        color: #ffffff;
        line-height: 1.25;
      }
      .article-card-excerpt {
        margin: 0;
        color: rgba(255, 255, 255, 0.82);
        line-height: 1.4;
        font-size: clamp(0.72rem, 0.95vw, 0.82rem);
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      @media (max-width: 1024px) {
        .article-card h3 {
          font-size: 0.9rem;
        }
      }
    </style>
    <script type="application/json" id="article-data" set:html={articlePayload}></script>
    <script type="module" src="./main.js"></script>
  </body>
</html>
